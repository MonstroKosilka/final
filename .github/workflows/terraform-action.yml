name: Terraform plan -> PR comment

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "infrastructure/terraform/**"
      - ".github/workflows/terraform-action.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"
          terraform_wrapper: false

      - name: Terraform version
        run: terraform version

      - name: Configure Yandex Cloud Secrets
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          mkdir -p "$RUNNER_TEMP/yc"
          echo "$YC_SA_KEY_JSON" > "$RUNNER_TEMP/yc/sa-key.json"
          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$RUNNER_TEMP/yc/sa-key.json" >> $GITHUB_ENV
          echo "YC_CLOUD_ID=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      - name: Terrafrom Init
        run: terraform init -input=false

      - name: Terraform Plan (capture output)
        id: plan
        run: |
          set -o pipefail
          terraform plan -input=false -no-color | tee plan.txt
        continue-on-error: true

      - name: Extract diff summary
        id: summary
        run: |
          SUMMARY="–ò—Ç–æ–≥ terraform plan –Ω–µ –Ω–∞–π–¥–µ–Ω"

          FOUND="$(grep -Eo 'Plan: [0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\.' plan.txt | tail -n 1 || true)"
          if [ -n "$FOUND" ]; then
            SUMMARY="$FOUND"
          fi

          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Prepare PR comment
        run: |
          PLAN=$(sed -e 's/`/\\`/g' plan.txt)

          STATUS="${{ steps.plan.outcome }}"
          if [ "$STATUS" = "success" ]; then
            BADGE="‚úÖ"
          else
            BADGE="‚ö†Ô∏è"
          fi

          cat <<EOF > comment.md
          ## üß© Terraform plan $BADGE

          **–†–∞–∑–ª–∏—á–∏—è:** \`${{ steps.summary.outputs.summary }}\`  
          **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** \`${{ github.repository }}\` ‚Ä¢ **PR:** #${{ github.event.pull_request.number }} ‚Ä¢ **–ê–≤—Ç–æ—Ä:** @${{ github.event.pull_request.user.login }}

          <details>
          <summary>üìú –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π plan</summary>

          \`\`\`
          $PLAN
          \`\`\`

          </details>
          EOF

      - name: Comment PR (create or update)
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: infrastructure/terraform/comment.md
      
      - name: Send Terraform plan to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          MESSAGE="üß© Terraform plan
            üì¶ Repo: $REPO
            üîÄ PR #$PR_NUMBER: $PR_TITLE
            üîó $PR_URL"

          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode=HTML