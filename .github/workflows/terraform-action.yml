name: Terraform plan -> PR comment -> Terraform apply

on:
  pull_request:
    branches: [ "main" ]
    paths:
      - "infrastructure/terraform/**"
      - ".github/workflows/terraform-action.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"
          terraform_wrapper: false

      - name: Terraform version
        run: terraform version

      - name: Configure Yandex Cloud Secrets
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          mkdir -p "$RUNNER_TEMP/yc"
          echo "$YC_SA_KEY_JSON" > "$RUNNER_TEMP/yc/sa-key.json"
          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$RUNNER_TEMP/yc/sa-key.json" >> $GITHUB_ENV
          echo "YC_CLOUD_ID=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      - name: Configure S3 backend creds (Yandex Object Storage)
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.YC_S3_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.YC_S3_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=ru-central1" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV

      - name: Terrafrom Init
        run: terraform init -input=false

      - name: Terraform Plan (capture output)
        id: plan
        run: |
          set -o pipefail
          terraform plan -input=false -no-color | tee plan.txt
        continue-on-error: true

      - name: Extract diff summary
        id: summary
        run: |
          SUMMARY="–ò—Ç–æ–≥ terraform plan –Ω–µ –Ω–∞–π–¥–µ–Ω"

          FOUND="$(grep -Eo 'Plan: [0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\.' plan.txt | tail -n 1 || true)"
          if [ -n "$FOUND" ]; then
            SUMMARY="$FOUND"
          fi

          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

      - name: Prepare PR comment
        run: |
          PLAN=$(sed -e 's/`/\\`/g' plan.txt)

          STATUS="${{ steps.plan.outcome }}"
          if [ "$STATUS" = "success" ]; then
            BADGE="‚úÖ"
          else
            BADGE="‚ö†Ô∏è"
          fi

          cat <<EOF > comment.md
          ## üß© Terraform plan $BADGE

          **–†–∞–∑–ª–∏—á–∏—è:** \`${{ steps.summary.outputs.summary }}\`  
          **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** \`${{ github.repository }}\` ‚Ä¢ **PR:** #${{ github.event.pull_request.number }} ‚Ä¢ **–ê–≤—Ç–æ—Ä:** @${{ github.event.pull_request.user.login }}

          <details>
          <summary>üìú –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π plan</summary>

          \`\`\`
          $PLAN
          \`\`\`

          </details>
          EOF

      - name: Comment PR (create or update)
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: infrastructure/terraform/comment.md
      
      - name: Send Terraform plan to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          MESSAGE="üß© Terraform plan
            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO
            üîÄ PR #$PR_NUMBER: $PR_TITLE
            üîó $PR_URL"

          curl -s -X POST "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode=HTML
  
  notify_telegram:
    name: Notify Telegram (PR -> main)
    runs-on: ubuntu-latest
    needs: plan
    steps:
      - name: Notify Telegram
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MSG: |
            ‚è≥ ${{ github.workflow }} –æ–∂–∏–¥–∞–µ—Ç —Ä—É—á–Ω–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è –Ω–∞ –≤–Ω–µ—Å–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–±–ª–∞—á–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            –°—Ç–∞—Ç—É—Å: ${{ job.status }}
            –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "disable_web_page_preview=true"
  apply:
    runs-on: ubuntu-latest
    needs: notify_telegram
    environment: deploy
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"
          terraform_wrapper: false

      - name: Terraform version
        run: terraform version

      - name: Configure Yandex Cloud Secrets
        env:
          YC_SA_KEY_JSON: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          mkdir -p "$RUNNER_TEMP/yc"
          echo "$YC_SA_KEY_JSON" > "$RUNNER_TEMP/yc/sa-key.json"
          echo "YC_SERVICE_ACCOUNT_KEY_FILE=$RUNNER_TEMP/yc/sa-key.json" >> $GITHUB_ENV
          echo "YC_CLOUD_ID=${{ secrets.YC_CLOUD_ID }}" >> $GITHUB_ENV
          echo "YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }}" >> $GITHUB_ENV

      - name: Configure S3 backend creds (Yandex Object Storage)
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.YC_S3_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.YC_S3_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=ru-central1" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV

      - name: Terrafrom Init
        run: terraform init -input=false

      - name: Terraform Apply
        id: apply
        run: |
          set -o pipefail
          terraform apply -input=false -auto-approve -no-color | tee apply.txt

      - name: Notify Telegram
        if: always()
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ job.status }}
          MSG: |
            üöÄ Terraform apply (${STATUS})
            –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}
            –í–µ—Ç–∫–∞: ${{ github.ref_name }}
            –ê–≤—Ç–æ—Ä: ${{ github.actor }}
            –°—Ç–∞—Ç—É—Å: ${{ job.status }}
            –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}

            –°—Å—ã–ª–∫–∞ –Ω–∞ job: –°—Å—ã–ª–∫–∞: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${MSG}" \
            --data-urlencode "disable_web_page_preview=true"
      